\doxysection{Log\+\_\+flash}
\hypertarget{group__log__flash}{}\label{group__log__flash}\index{Log\_flash@{Log\_flash}}
\doxysubsubsection*{Files}
\begin{DoxyCompactItemize}
\item 
file \mbox{\hyperlink{log__flash_8h}{log\+\_\+flash.\+h}}
\begin{DoxyCompactList}\small\item\em Public API for flash-\/based logging of system events and errors. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Classes}
\begin{DoxyCompactItemize}
\item 
struct \mbox{\hyperlink{struct_log_msg__t}{Log\+Msg\+\_\+t}}
\begin{DoxyCompactList}\small\item\em Log message structure for queued events. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \mbox{\hyperlink{group__log__flash_ga5f3b99e0966ad05cc569bea9b503b148}{Log\+\_\+\+Init}} (void)
\begin{DoxyCompactList}\small\item\em Message structure used for asynchronous logging via RTOS queue. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{group__log__flash_ga9a06f8947190ea69e5f7f6748a957855}{Log\+\_\+\+Erase\+All}} (void)
\item 
struct \mbox{\hyperlink{group__log__flash_gab898071398b359603a35c202e9c65f3b}{\+\_\+\+\_\+attribute\+\_\+\+\_\+}} ((packed))
\begin{DoxyCompactList}\small\item\em Represents a single flash log record. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{group__log__flash_gaf7be7be3d5aa3ad8ce8eb8f080d34baa}{Log\+\_\+\+Append}} (uint16\+\_\+t code, uint16\+\_\+t flags, const char \texorpdfstring{$\ast$}{*}msg)
\begin{DoxyCompactList}\small\item\em Append a new record to the flash log. \end{DoxyCompactList}\item 
int \mbox{\hyperlink{group__log__flash_ga661cd6aecf9a843941229e9789ef8d8f}{Log\+\_\+\+Read\+LastN}} (uint32\+\_\+t n, \mbox{\hyperlink{group__log__flash_gaa8e473f8371172fa02b2ecf3bf4b2010}{Log\+Rec}} \texorpdfstring{$\ast$}{*}out, uint32\+\_\+t max\+\_\+out)
\begin{DoxyCompactList}\small\item\em Read the last {\ttfamily n} records from flash. \end{DoxyCompactList}\item 
int \mbox{\hyperlink{group__log__flash_ga68cbde1bd242d16f0c97aa1a6a982674}{Log\+\_\+\+Count\+Valid}} (void)
\begin{DoxyCompactList}\small\item\em Count the number of valid (committed) records currently stored. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{group__log__flash_gae4a37f521a0098079c9f62bb1014569f}{v\+Task\+Log\+Writer}} (void \texorpdfstring{$\ast$}{*}argument)
\begin{DoxyCompactList}\small\item\em Free\+RTOS task responsible for writing queued log messages to flash. \end{DoxyCompactList}\item 
uint32\+\_\+t \mbox{\hyperlink{group__log__flash_gab44417e89973f9f0c7b2d0aaa7ba25ac}{Log\+\_\+\+Get\+Write\+Index}} (void)
\begin{DoxyCompactList}\small\item\em Get the current write index within the circular buffer. \end{DoxyCompactList}\item 
uint32\+\_\+t \mbox{\hyperlink{group__log__flash_ga2d734e69f4ea869029a8bb750d24540d}{Log\+\_\+\+Get\+Sequence\+Next}} (void)
\begin{DoxyCompactList}\small\item\em Get the next sequential record number to be assigned. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Variables}
\begin{DoxyCompactItemize}
\item 
uint32\+\_\+t \mbox{\hyperlink{group__log__flash_ga2e3467bd12b4bc5a03d2ef75df455976}{wr\+\_\+index}}
\begin{DoxyCompactList}\small\item\em Current write position in circular log (0..LOG\+\_\+\+CAPACITY-\/1). \end{DoxyCompactList}\item 
uint32\+\_\+t \mbox{\hyperlink{group__log__flash_ga960039267784d0b901fd31737f74220d}{seq\+\_\+next}}
\begin{DoxyCompactList}\small\item\em Next sequential record number (increments on each append). \end{DoxyCompactList}\item 
\mbox{\hyperlink{group__log__flash_gaa8e473f8371172fa02b2ecf3bf4b2010}{Log\+Rec}}
\item 
os\+Message\+Queue\+Id\+\_\+t \mbox{\hyperlink{group__log__flash_gaa42f4a4e54ef104c44df1ce00a619e7a}{log\+Queue}}
\begin{DoxyCompactList}\small\item\em Global handle for the log message queue. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Flash log layout configuration}
\begin{DoxyCompactItemize}
\item 
\#define \mbox{\hyperlink{group__log__flash_gacdd7c55a0924d6deca8d60fa4c46af20}{LOG\+\_\+\+BASE}}~0x000000
\item 
\#define \mbox{\hyperlink{group__log__flash_gaa3d18ef8bebba9252ee656ca4db2eba4}{LOG\+\_\+\+SECTORS}}~2
\item 
\#define \mbox{\hyperlink{group__log__flash_gaa35bad1e92008da628f27b2f6bb270aa}{SECTOR\+\_\+\+SIZE}}~4096
\item 
\#define \mbox{\hyperlink{group__log__flash_gaf2626f3f54ad88732c3309a5c0c01760}{REC\+\_\+\+SIZE}}~sizeof(\mbox{\hyperlink{group__log__flash_gaa8e473f8371172fa02b2ecf3bf4b2010}{Log\+Rec}})
\item 
\#define \mbox{\hyperlink{group__log__flash_gadb2ca259a26eb6fff68cba2fe15a38ca}{RECS\+\_\+\+PER\+\_\+\+SECTOR}}~(\mbox{\hyperlink{group__log__flash_gaa35bad1e92008da628f27b2f6bb270aa}{SECTOR\+\_\+\+SIZE}} / \mbox{\hyperlink{group__log__flash_gaf2626f3f54ad88732c3309a5c0c01760}{REC\+\_\+\+SIZE}})
\item 
\#define \mbox{\hyperlink{group__log__flash_ga3e6daaec7e3afbd03bd78beaab01d0b9}{LOG\+\_\+\+CAPACITY}}~(\mbox{\hyperlink{group__log__flash_gaa3d18ef8bebba9252ee656ca4db2eba4}{LOG\+\_\+\+SECTORS}} \texorpdfstring{$\ast$}{*} \mbox{\hyperlink{group__log__flash_gadb2ca259a26eb6fff68cba2fe15a38ca}{RECS\+\_\+\+PER\+\_\+\+SECTOR}})
\item 
\#define \mbox{\hyperlink{group__log__flash_ga1d5f5afa4da8aae64bc415c5596fab41}{COMMIT\+\_\+\+VAL}}~0x7E
\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}


\doxysubsection{Macro Definition Documentation}
\Hypertarget{group__log__flash_ga1d5f5afa4da8aae64bc415c5596fab41}\label{group__log__flash_ga1d5f5afa4da8aae64bc415c5596fab41} 
\index{Log\_flash@{Log\_flash}!COMMIT\_VAL@{COMMIT\_VAL}}
\index{COMMIT\_VAL@{COMMIT\_VAL}!Log\_flash@{Log\_flash}}
\doxysubsubsection{\texorpdfstring{COMMIT\_VAL}{COMMIT\_VAL}}
{\footnotesize\ttfamily \#define COMMIT\+\_\+\+VAL~0x7E}

Commit marker written after record is valid \Hypertarget{group__log__flash_gacdd7c55a0924d6deca8d60fa4c46af20}\label{group__log__flash_gacdd7c55a0924d6deca8d60fa4c46af20} 
\index{Log\_flash@{Log\_flash}!LOG\_BASE@{LOG\_BASE}}
\index{LOG\_BASE@{LOG\_BASE}!Log\_flash@{Log\_flash}}
\doxysubsubsection{\texorpdfstring{LOG\_BASE}{LOG\_BASE}}
{\footnotesize\ttfamily \#define LOG\+\_\+\+BASE~0x000000}

Start address of log area in flash \Hypertarget{group__log__flash_ga3e6daaec7e3afbd03bd78beaab01d0b9}\label{group__log__flash_ga3e6daaec7e3afbd03bd78beaab01d0b9} 
\index{Log\_flash@{Log\_flash}!LOG\_CAPACITY@{LOG\_CAPACITY}}
\index{LOG\_CAPACITY@{LOG\_CAPACITY}!Log\_flash@{Log\_flash}}
\doxysubsubsection{\texorpdfstring{LOG\_CAPACITY}{LOG\_CAPACITY}}
{\footnotesize\ttfamily \#define LOG\+\_\+\+CAPACITY~(\mbox{\hyperlink{group__log__flash_gaa3d18ef8bebba9252ee656ca4db2eba4}{LOG\+\_\+\+SECTORS}} \texorpdfstring{$\ast$}{*} \mbox{\hyperlink{group__log__flash_gadb2ca259a26eb6fff68cba2fe15a38ca}{RECS\+\_\+\+PER\+\_\+\+SECTOR}})}

Total number of records \Hypertarget{group__log__flash_gaa3d18ef8bebba9252ee656ca4db2eba4}\label{group__log__flash_gaa3d18ef8bebba9252ee656ca4db2eba4} 
\index{Log\_flash@{Log\_flash}!LOG\_SECTORS@{LOG\_SECTORS}}
\index{LOG\_SECTORS@{LOG\_SECTORS}!Log\_flash@{Log\_flash}}
\doxysubsubsection{\texorpdfstring{LOG\_SECTORS}{LOG\_SECTORS}}
{\footnotesize\ttfamily \#define LOG\+\_\+\+SECTORS~2}

Number of 4KB sectors reserved for logging \Hypertarget{group__log__flash_gaf2626f3f54ad88732c3309a5c0c01760}\label{group__log__flash_gaf2626f3f54ad88732c3309a5c0c01760} 
\index{Log\_flash@{Log\_flash}!REC\_SIZE@{REC\_SIZE}}
\index{REC\_SIZE@{REC\_SIZE}!Log\_flash@{Log\_flash}}
\doxysubsubsection{\texorpdfstring{REC\_SIZE}{REC\_SIZE}}
{\footnotesize\ttfamily \#define REC\+\_\+\+SIZE~sizeof(\mbox{\hyperlink{group__log__flash_gaa8e473f8371172fa02b2ecf3bf4b2010}{Log\+Rec}})}

Size of each log record in bytes \Hypertarget{group__log__flash_gadb2ca259a26eb6fff68cba2fe15a38ca}\label{group__log__flash_gadb2ca259a26eb6fff68cba2fe15a38ca} 
\index{Log\_flash@{Log\_flash}!RECS\_PER\_SECTOR@{RECS\_PER\_SECTOR}}
\index{RECS\_PER\_SECTOR@{RECS\_PER\_SECTOR}!Log\_flash@{Log\_flash}}
\doxysubsubsection{\texorpdfstring{RECS\_PER\_SECTOR}{RECS\_PER\_SECTOR}}
{\footnotesize\ttfamily \#define RECS\+\_\+\+PER\+\_\+\+SECTOR~(\mbox{\hyperlink{group__log__flash_gaa35bad1e92008da628f27b2f6bb270aa}{SECTOR\+\_\+\+SIZE}} / \mbox{\hyperlink{group__log__flash_gaf2626f3f54ad88732c3309a5c0c01760}{REC\+\_\+\+SIZE}})}

Records stored per 4KB sector \Hypertarget{group__log__flash_gaa35bad1e92008da628f27b2f6bb270aa}\label{group__log__flash_gaa35bad1e92008da628f27b2f6bb270aa} 
\index{Log\_flash@{Log\_flash}!SECTOR\_SIZE@{SECTOR\_SIZE}}
\index{SECTOR\_SIZE@{SECTOR\_SIZE}!Log\_flash@{Log\_flash}}
\doxysubsubsection{\texorpdfstring{SECTOR\_SIZE}{SECTOR\_SIZE}}
{\footnotesize\ttfamily \#define SECTOR\+\_\+\+SIZE~4096}

Flash sector size in bytes 

\doxysubsection{Function Documentation}
\Hypertarget{group__log__flash_gab898071398b359603a35c202e9c65f3b}\label{group__log__flash_gab898071398b359603a35c202e9c65f3b} 
\index{Log\_flash@{Log\_flash}!\_\_attribute\_\_@{\_\_attribute\_\_}}
\index{\_\_attribute\_\_@{\_\_attribute\_\_}!Log\_flash@{Log\_flash}}
\doxysubsubsection{\texorpdfstring{\_\_attribute\_\_()}{\_\_attribute\_\_()}}
{\footnotesize\ttfamily struct \+\_\+\+\_\+attribute\+\_\+\+\_\+ (\begin{DoxyParamCaption}\item[{(packed)}]{ }\end{DoxyParamCaption})}



Represents a single flash log record. 

The last byte ({\ttfamily commit}) is written after the rest of the record to indicate that the record was successfully committed. If {\ttfamily commit != 0x7E}, the record is considered invalid or unwritten. \texorpdfstring{$<$}{<} Sequential record number

\texorpdfstring{$<$}{<} System tick time in milliseconds

\texorpdfstring{$<$}{<} Event or error code

\texorpdfstring{$<$}{<} Optional bit flags

\texorpdfstring{$<$}{<} Short ASCII message or description

\texorpdfstring{$<$}{<} Commit marker (0x7E = valid)\Hypertarget{group__log__flash_gaf7be7be3d5aa3ad8ce8eb8f080d34baa}\label{group__log__flash_gaf7be7be3d5aa3ad8ce8eb8f080d34baa} 
\index{Log\_flash@{Log\_flash}!Log\_Append@{Log\_Append}}
\index{Log\_Append@{Log\_Append}!Log\_flash@{Log\_flash}}
\doxysubsubsection{\texorpdfstring{Log\_Append()}{Log\_Append()}}
{\footnotesize\ttfamily void Log\+\_\+\+Append (\begin{DoxyParamCaption}\item[{uint16\+\_\+t}]{code,  }\item[{uint16\+\_\+t}]{flags,  }\item[{const char \texorpdfstring{$\ast$}{*}}]{msg }\end{DoxyParamCaption})}



Append a new record to the flash log. 

Automatically erases sectors when wrapping into a new one. If the log is full, it overwrites the oldest entries (circular buffer).


\begin{DoxyParams}{Parameters}
{\em code} & Event or fault code \\
\hline
{\em flags} & Optional bit flags \\
\hline
{\em msg} & Null-\/terminated message (max 20 chars) \\
\hline
\end{DoxyParams}
\Hypertarget{group__log__flash_ga68cbde1bd242d16f0c97aa1a6a982674}\label{group__log__flash_ga68cbde1bd242d16f0c97aa1a6a982674} 
\index{Log\_flash@{Log\_flash}!Log\_CountValid@{Log\_CountValid}}
\index{Log\_CountValid@{Log\_CountValid}!Log\_flash@{Log\_flash}}
\doxysubsubsection{\texorpdfstring{Log\_CountValid()}{Log\_CountValid()}}
{\footnotesize\ttfamily int Log\+\_\+\+Count\+Valid (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



Count the number of valid (committed) records currently stored. 

\begin{DoxyReturn}{Returns}
Count of valid records 
\end{DoxyReturn}
\Hypertarget{group__log__flash_ga9a06f8947190ea69e5f7f6748a957855}\label{group__log__flash_ga9a06f8947190ea69e5f7f6748a957855} 
\index{Log\_flash@{Log\_flash}!Log\_EraseAll@{Log\_EraseAll}}
\index{Log\_EraseAll@{Log\_EraseAll}!Log\_flash@{Log\_flash}}
\doxysubsubsection{\texorpdfstring{Log\_EraseAll()}{Log\_EraseAll()}}
{\footnotesize\ttfamily void Log\+\_\+\+Erase\+All (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}

Erase all log sectors in flash. \Hypertarget{group__log__flash_ga2d734e69f4ea869029a8bb750d24540d}\label{group__log__flash_ga2d734e69f4ea869029a8bb750d24540d} 
\index{Log\_flash@{Log\_flash}!Log\_GetSequenceNext@{Log\_GetSequenceNext}}
\index{Log\_GetSequenceNext@{Log\_GetSequenceNext}!Log\_flash@{Log\_flash}}
\doxysubsubsection{\texorpdfstring{Log\_GetSequenceNext()}{Log\_GetSequenceNext()}}
{\footnotesize\ttfamily uint32\+\_\+t Log\+\_\+\+Get\+Sequence\+Next (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



Get the next sequential record number to be assigned. 

\begin{DoxyReturn}{Returns}
Next sequence number 
\end{DoxyReturn}
\Hypertarget{group__log__flash_gab44417e89973f9f0c7b2d0aaa7ba25ac}\label{group__log__flash_gab44417e89973f9f0c7b2d0aaa7ba25ac} 
\index{Log\_flash@{Log\_flash}!Log\_GetWriteIndex@{Log\_GetWriteIndex}}
\index{Log\_GetWriteIndex@{Log\_GetWriteIndex}!Log\_flash@{Log\_flash}}
\doxysubsubsection{\texorpdfstring{Log\_GetWriteIndex()}{Log\_GetWriteIndex()}}
{\footnotesize\ttfamily uint32\+\_\+t Log\+\_\+\+Get\+Write\+Index (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



Get the current write index within the circular buffer. 

\begin{DoxyReturn}{Returns}
Current write index (0â€¦\+LOG\+\_\+\+CAPACITY-\/1) 
\end{DoxyReturn}
\Hypertarget{group__log__flash_ga5f3b99e0966ad05cc569bea9b503b148}\label{group__log__flash_ga5f3b99e0966ad05cc569bea9b503b148} 
\index{Log\_flash@{Log\_flash}!Log\_Init@{Log\_Init}}
\index{Log\_Init@{Log\_Init}!Log\_flash@{Log\_flash}}
\doxysubsubsection{\texorpdfstring{Log\_Init()}{Log\_Init()}}
{\footnotesize\ttfamily void Log\+\_\+\+Init (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



Message structure used for asynchronous logging via RTOS queue. 

Initialize flash logging system.

Initialise the flash log system and locate the next available slot.

Scans the flash area for existing records and resumes the sequence number from the last committed entry. \Hypertarget{group__log__flash_ga661cd6aecf9a843941229e9789ef8d8f}\label{group__log__flash_ga661cd6aecf9a843941229e9789ef8d8f} 
\index{Log\_flash@{Log\_flash}!Log\_ReadLastN@{Log\_ReadLastN}}
\index{Log\_ReadLastN@{Log\_ReadLastN}!Log\_flash@{Log\_flash}}
\doxysubsubsection{\texorpdfstring{Log\_ReadLastN()}{Log\_ReadLastN()}}
{\footnotesize\ttfamily int Log\+\_\+\+Read\+LastN (\begin{DoxyParamCaption}\item[{uint32\+\_\+t}]{n,  }\item[{\mbox{\hyperlink{group__log__flash_gaa8e473f8371172fa02b2ecf3bf4b2010}{Log\+Rec}} \texorpdfstring{$\ast$}{*}}]{out,  }\item[{uint32\+\_\+t}]{max\+\_\+out }\end{DoxyParamCaption})}



Read the last {\ttfamily n} records from flash. 


\begin{DoxyParams}{Parameters}
{\em n} & Number of records to read \\
\hline
{\em out} & Pointer to array of Log\+Rec \\
\hline
{\em max\+\_\+out} & Maximum number of records that can be stored in {\ttfamily out} \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Number of records actually read 
\end{DoxyReturn}
\Hypertarget{group__log__flash_gae4a37f521a0098079c9f62bb1014569f}\label{group__log__flash_gae4a37f521a0098079c9f62bb1014569f} 
\index{Log\_flash@{Log\_flash}!vTaskLogWriter@{vTaskLogWriter}}
\index{vTaskLogWriter@{vTaskLogWriter}!Log\_flash@{Log\_flash}}
\doxysubsubsection{\texorpdfstring{vTaskLogWriter()}{vTaskLogWriter()}}
{\footnotesize\ttfamily void v\+Task\+Log\+Writer (\begin{DoxyParamCaption}\item[{void \texorpdfstring{$\ast$}{*}}]{argument }\end{DoxyParamCaption})}



Free\+RTOS task responsible for writing queued log messages to flash. 

This task waits on \doxylink{group__log__flash_gaa42f4a4e54ef104c44df1ce00a619e7a}{log\+Queue} and appends messages as they arrive.


\begin{DoxyParams}{Parameters}
{\em argument} & Unused task argument \\
\hline
\end{DoxyParams}


\doxysubsection{Variable Documentation}
\Hypertarget{group__log__flash_gaa42f4a4e54ef104c44df1ce00a619e7a}\label{group__log__flash_gaa42f4a4e54ef104c44df1ce00a619e7a} 
\index{Log\_flash@{Log\_flash}!logQueue@{logQueue}}
\index{logQueue@{logQueue}!Log\_flash@{Log\_flash}}
\doxysubsubsection{\texorpdfstring{logQueue}{logQueue}}
{\footnotesize\ttfamily os\+Message\+Queue\+Id\+\_\+t log\+Queue\hspace{0.3cm}{\ttfamily [extern]}}



Global handle for the log message queue. 

This queue receives \doxylink{struct_log_msg__t}{Log\+Msg\+\_\+t} structures from other tasks and is processed by \doxylink{group__log__flash_gae4a37f521a0098079c9f62bb1014569f}{v\+Task\+Log\+Writer}. \Hypertarget{group__log__flash_gaa8e473f8371172fa02b2ecf3bf4b2010}\label{group__log__flash_gaa8e473f8371172fa02b2ecf3bf4b2010} 
\index{Log\_flash@{Log\_flash}!LogRec@{LogRec}}
\index{LogRec@{LogRec}!Log\_flash@{Log\_flash}}
\doxysubsubsection{\texorpdfstring{LogRec}{LogRec}}
{\footnotesize\ttfamily Log\+Rec}

\Hypertarget{group__log__flash_ga960039267784d0b901fd31737f74220d}\label{group__log__flash_ga960039267784d0b901fd31737f74220d} 
\index{Log\_flash@{Log\_flash}!seq\_next@{seq\_next}}
\index{seq\_next@{seq\_next}!Log\_flash@{Log\_flash}}
\doxysubsubsection{\texorpdfstring{seq\_next}{seq\_next}}
{\footnotesize\ttfamily uint32\+\_\+t seq\+\_\+next\hspace{0.3cm}{\ttfamily [extern]}}



Next sequential record number (increments on each append). 

\Hypertarget{group__log__flash_ga2e3467bd12b4bc5a03d2ef75df455976}\label{group__log__flash_ga2e3467bd12b4bc5a03d2ef75df455976} 
\index{Log\_flash@{Log\_flash}!wr\_index@{wr\_index}}
\index{wr\_index@{wr\_index}!Log\_flash@{Log\_flash}}
\doxysubsubsection{\texorpdfstring{wr\_index}{wr\_index}}
{\footnotesize\ttfamily uint32\+\_\+t wr\+\_\+index\hspace{0.3cm}{\ttfamily [extern]}}



Current write position in circular log (0..LOG\+\_\+\+CAPACITY-\/1). 

